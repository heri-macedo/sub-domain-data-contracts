name: Push Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'data_contracts/**'
      - 'resources/**'
      - 'databricks.yaml'
      - 'requirements*.txt'
      - '.github/workflows/**'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================================================
  # Validate Contracts (YAML validation - no Databricks needed)
  # ===========================================================================
  validate-contracts:
    name: Validate Contracts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"
          pip install -r requirements.txt

      - name: Validate contracts
        run: databricks-contracts validate all

  # ===========================================================================
  # Validate & Deploy Bundle
  # ===========================================================================
  validate-and-deploy:
    name: Validate & Deploy
    runs-on: ubuntu-latest
    needs: [validate-contracts]
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      - name: Install dependencies
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"
          pip install -r requirements.txt

      # =========================================================================
      # Setup Databricks Credentials (based on branch)
      # =========================================================================
      - name: Setup Databricks Credentials
        id: setup-creds
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ğŸ” Configuring PROD credentials..."
            echo "target=prod" >> $GITHUB_OUTPUT
            echo "DATABRICKS_HOST=${{ secrets.DATABRICKS_HOST_PROD }}" >> $GITHUB_ENV
            echo "DATABRICKS_CLIENT_ID=${{ secrets.DATABRICKS_SP_CLIENT_ID_PROD }}" >> $GITHUB_ENV
            echo "DATABRICKS_CLIENT_SECRET=${{ secrets.DATABRICKS_SP_SECRET_PROD }}" >> $GITHUB_ENV
            echo "BUNDLE_VAR_sp_client_id=${{ secrets.DATABRICKS_SP_CLIENT_ID_PROD }}" >> $GITHUB_ENV
          else
            echo "ğŸ” Configuring DEV credentials..."
            echo "target=dev" >> $GITHUB_OUTPUT
            echo "DATABRICKS_HOST=${{ secrets.DATABRICKS_HOST_DEV }}" >> $GITHUB_ENV
            echo "DATABRICKS_CLIENT_ID=${{ secrets.DATABRICKS_SP_CLIENT_ID_DEV }}" >> $GITHUB_ENV
            echo "DATABRICKS_CLIENT_SECRET=${{ secrets.DATABRICKS_SP_SECRET_DEV }}" >> $GITHUB_ENV
            echo "BUNDLE_VAR_sp_client_id=${{ secrets.DATABRICKS_SP_CLIENT_ID_DEV }}" >> $GITHUB_ENV
          fi
          echo "âœ… Credentials configured for target: ${{ steps.setup-creds.outputs.target || 'dev' }}"

      - name: Validate bundle
        run: |
          echo "ğŸ” Validating bundle for target: ${{ steps.setup-creds.outputs.target }}"
          databricks bundle validate -t ${{ steps.setup-creds.outputs.target }}

      # =========================================================================
      # Deploy Bundle
      # =========================================================================
      - name: Deploy Bundle
        run: |
          echo "ğŸš€ Deploying bundle to ${{ steps.setup-creds.outputs.target }}..."
          databricks bundle deploy -t ${{ steps.setup-creds.outputs.target }}
          echo "âœ… Bundle deployed!"

      # =========================================================================
      # Trigger Modified Contracts
      # =========================================================================
      - name: Trigger modified contracts
        run: |
          echo "ğŸ”„ Triggering modified contracts..."
          databricks-contracts trigger modified --env ${{ steps.setup-creds.outputs.target }}
